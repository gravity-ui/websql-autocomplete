import {IStatementsVisitor, StatementPosition} from '../../shared';
import {getStatementEndIndex} from '../../shared/extract-statement-positions-from-query';
import {StatementsContext} from './generated/PostgreSqlParser';
import {PostgreSqlParserVisitor} from './generated/PostgreSqlParserVisitor';

export class PostgreSqlStatementsVisitor
    extends PostgreSqlParserVisitor<unknown>
    implements IStatementsVisitor
{
    statementPositions: StatementPosition[] = [];
    lastTokenIndex = 0;

    visitStatements = (context: StatementsContext): void => {
        if (!context.start || !context.stop) {
            return;
        }

        // Linter doesn't like uppercase function names, but this name is generated by ANTLR
        // eslint-disable-next-line new-cap
        const semi = context.SEMI();

        this.statementPositions.push({
            startIndex: context.start.start,
            endIndex: getStatementEndIndex(context.stop, semi),
        });

        const otherStatements = context.statements();
        if (otherStatements) {
            this.visitStatements(otherStatements);
        } else {
            this.lastTokenIndex = semi ? semi.symbol.tokenIndex : context.stop.tokenIndex;
        }
    };
}
